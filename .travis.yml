git :
 depth : 5

stages :
 - "Build and Test"
 - "Package"
 
jobs :
 include :
 - stage : "Build and Test"
   language : java
   jdk : oraclejdk11
   before_script :
    - cd sample-application-backend
   script :
   - echo "Maven build"
   - echo "Run test coverage and Quality Gate"
 - stage : "Build and Test"
   language : node.js
   node_js : "12.20"
   before_script :
    - cd sample-application-frontend
   script :
    - echo "NPM install and build"
 - stage : "Package"
   before_script :
    - cd sample-application-backend
   script :
    - echo "Docker build ..."
    - docker build -t vvalette/backend .
    - echo "Docker login ..."
    - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
    - echo "Docker push ..."
    - docker push vvalette/backend
 - stage : "Package"
   before_script :
    - cd sample-application-frontend
   script :
    - echo "Docker build ..."
    - docker build -t vvalette/frontend .
    - echo "Docker login ..."
    - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
    - echo "Docker push ..."
    - docker push vvalette/frontend
 - stage : "Quality"
   language : java
   script :
    - mvn clean verify org.jacoco:jacoco-maven-plugin:prepare-agent install sonar:sonar -Dsonar.projectKey=vvalette_sample-application-students

cache :
 directories :
  - "$HOME/.m2/repository"
  - "$HOME/.npm"
  
services :
 - docker

addons :
 sonarcloud :
  organization : "vvalette"
  token : "$SONARCLOUD_TOKEN"
